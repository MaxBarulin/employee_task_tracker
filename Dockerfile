# ШАГ 1: Базовый образ
# Берем официальный, легковесный образ Python 3.11.
FROM python:3.11-slim

# ШАГ 2: Переменные окружения
# Говорим Python не создавать .pyc файлы и выводить все в консоль без буферизации.
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

# ШАГ 3: Рабочая директория
# Создаем и переходим в папку /app внутри контейнера. Все последующие команды будут выполняться там.
WORKDIR /app

# ШАГ 4: Установка Poetry
# Устанавливаем Poetry, чтобы управлять зависимостями.
RUN pip install --upgrade pip
RUN pip install poetry

# ШАГ 5: Установка зависимостей (Оптимизированный шаг)
# Копируем ТОЛЬКО файлы с зависимостями. Docker кэширует этот слой.
# Если вы поменяете код, но не зависимости, Docker не будет переустанавливать все заново.
COPY poetry.lock pyproject.toml /app/

# Устанавливаем зависимости проекта, но без dev-пакетов (они не нужны в продакшене).
# `virtualenvs.create false` говорит poetry использовать системный python, а не создавать еще одно окружение.
RUN poetry config virtualenvs.create false && poetry install --no-root

# ШАГ 6: Копирование кода проекта
# Теперь, когда зависимости установлены, копируем весь остальной код вашего проекта.
COPY . /app/

# ШАГ 7: Открытие порта
# Сообщаем Docker, что наше приложение будет слушать порт 8000 внутри контейнера.
EXPOSE 8000

# ШАГ 8: Команда запуска
# Указываем, какую команду запустить, когда контейнер стартует.
# '0.0.0.0' ОБЯЗАТЕЛЬНО, чтобы сервер был доступен извне контейнера.
CMD ["python", "manage.py", "runserver", "0.0.0.0:8000"]
